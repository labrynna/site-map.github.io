<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Site Visit Map</title>
  <style>
    body { font-family: Arial, Helvetica, sans-serif; margin:0; display:flex; height:100vh; }
    #map { flex:1; min-width: 0; transition: all 0.3s ease; } /* map takes remaining space */
    #map.hidden { display: none; }
    body.map-hidden { justify-content: center; }
    body.map-hidden #sidebar { width: 100%; max-width: 800px; border-left: none; border: 1px solid #ddd; }
    #sidebar { width:360px; max-width:40%; overflow:auto; border-left:1px solid #ddd; padding:12px; box-sizing:border-box; background:#fafafa; transition: all 0.3s ease; }
    h1 { font-size:18px; margin:0 0 12px 0; }
    .place { padding:8px; margin-bottom:8px; border-radius:6px; background:#fff; box-shadow:0 1px 2px rgba(0,0,0,0.04); }
    .place .title { font-weight:600; font-size:14px; margin-bottom:4px; }
    .place .meta { font-size:12px; color:#666; margin-bottom:8px; }
    .btn { display:inline-block; padding:6px 8px; margin-right:6px; border-radius:4px; text-decoration:none; font-size:13px; cursor:pointer; }
    .btn-center { background:#1976d2; color:white; }
    .btn-open { background:#26a69a; color:white; }
    .btn-upload { background:#ff6f00; color:white; }
    .note { font-size:12px; color:#555; margin-bottom:10px; }
    footer { font-size:12px; color:#666; margin-top:8px; }
    .filter-section { margin-bottom:16px; padding:10px; background:#fff; border-radius:6px; box-shadow:0 1px 2px rgba(0,0,0,0.04); }
    .filter-section label { display:block; margin-bottom:6px; font-size:13px; font-weight:600; }
    .filter-options { display:flex; gap:8px; }
    .filter-btn { flex:1; padding:8px; border:1px solid #ccc; border-radius:4px; background:#fff; font-size:12px; cursor:pointer; transition: all 0.2s; }
    .filter-btn:hover { background:#f5f5f5; }
    .filter-btn.active { background:#1976d2; color:white; border-color:#1976d2; }
    .update-map-btn { width:100%; padding:12px; margin-bottom:16px; background:#4caf50; color:white; border:none; border-radius:6px; font-size:14px; font-weight:600; cursor:pointer; box-shadow:0 2px 4px rgba(0,0,0,0.1); transition: all 0.2s; }
    .update-map-btn:hover { background:#45a049; box-shadow:0 3px 6px rgba(0,0,0,0.15); }
    .update-map-btn:active { transform: scale(0.98); }
    .update-map-btn:disabled { background:#ccc; cursor:not-allowed; }
    .toggle-map-btn { width:100%; padding:12px; margin-bottom:16px; background:#ff9800; color:white; border:none; border-radius:6px; font-size:14px; font-weight:600; cursor:pointer; box-shadow:0 2px 4px rgba(0,0,0,0.1); transition: all 0.2s; }
    .toggle-map-btn:hover { background:#f57c00; box-shadow:0 3px 6px rgba(0,0,0,0.15); }
    .toggle-map-btn:active { transform: scale(0.98); }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="sidebar">
    <h1>Sites to Visit</h1>
    <button class="update-map-btn" id="updateMapBtn">Update Map</button>
    <button class="toggle-map-btn" id="toggleMapBtn">Hide Map</button>
    <div class="note">Addresses below are to be visited for Constructor Information Collection.</div>
    <div class="filter-section">
      <label>Filter:</label>
      <div class="filter-options">
        <button class="filter-btn active" data-filter="all">All</button>
        <button class="filter-btn" data-filter="not-visited">Not Visited</button>
        <button class="filter-btn" data-filter="visited">Visited</button>
      </div>
    </div>
    <div id="places"></div>
    <footer>
      <div>Tip: On mobile, "Open in Google Maps" will switch to the Maps app if installed.</div>
    </footer>
  </div>

  <script>
  // API key will be fetched securely from Netlify Functions
  // This keeps the API key secure in environment variables
  let API_KEY = null;

  let map;
  const markers = [];
  const placesEl = document.getElementById("places");
  let currentFilter = "all";

  function handleError(err) {
    console.error(err);
    const errorMessage = err.message || String(err);
    let displayMessage = `Error: ${escapeHtml(errorMessage)}`;
    
    // Provide helpful message for API key issues
    if (!API_KEY) {
      displayMessage = `<div class="note" style="color:#b00020; padding:12px; background:#ffebee; border-radius:4px; margin-bottom:12px;">
        <strong>⚠️ Google Maps API Key Configuration Required</strong><br><br>
        To display the map, you need to:<br>
        1. Get a free Google Maps API key from: <a href="https://developers.google.com/maps/documentation/javascript/get-api-key" target="_blank" style="color:#1976d2;">Google Maps Platform</a><br>
        2. Add your API key to Netlify environment variables as <strong>GOOGLE_MAPS_API_KEY</strong><br>
        3. Enable the "Maps JavaScript API" for your project<br>
        4. <strong>Restrict your API key</strong> to your domain in Google Cloud Console to prevent misuse<br><br>
        <small>Note: You may need to enable billing on your Google Cloud project, though Google provides $200 free credit per month.</small>
      </div>`;
    }
    placesEl.innerHTML = displayMessage;
  }

  // Use the recommended callback-based approach for loading Google Maps API
  window.initMap = function() {
    init().catch(handleError);
  };

  // Fetch API key from Netlify Function and then load Google Maps
  (async function loadGoogleMaps() {
    try {
      // Fetch API key from secure Netlify Function
      const response = await fetch('/.netlify/functions/get-maps-key');
      if (!response.ok) {
        throw new Error('Failed to fetch Google Maps API key from server');
      }
      const data = await response.json();
      API_KEY = data.apiKey;
      
      if (!API_KEY) {
        throw new Error('Google Maps API key not configured on server');
      }
      
      // Load Google Maps script
      const script = document.createElement("script");
      script.defer = true;
      script.async = true;
      script.src = `https://maps.googleapis.com/maps/api/js?key=${encodeURIComponent(API_KEY)}&callback=initMap`;
      script.onerror = () => handleError(new Error("Failed to load Google Maps JavaScript API. Please check your API key and ensure the Maps JavaScript API is enabled in your Google Cloud Console."));
      document.head.appendChild(script);
    } catch (error) {
      handleError(error);
    }
  })();

  async function init() {
    map = new google.maps.Map(document.getElementById("map"), {
      center: { lat: -33.8688, lng: 151.2093 },
      zoom: 12,
      mapTypeId: "roadmap"
    });

    let addresses;
    
    // Try to load fresh data from Google Sheets via Netlify Function first
    try {
      const functionResponse = await fetch('/.netlify/functions/update-map', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ timestamp: new Date().toISOString() })
      });
      
      if (functionResponse.ok) {
        const result = await functionResponse.json();
        if (result.success && result.data) {
          addresses = result.data;
          console.log('Loaded fresh data from Google Sheets');
        }
      }
    } catch (error) {
      console.warn('Could not load from Google Sheets, falling back to static file:', error);
    }
    
    // Fallback to static addresses.json file if function failed or returned no data
    if (!addresses) {
      const cacheBuster = new Date().getTime();
      const response = await fetch(`addresses.json?v=${cacheBuster}`);
      if (!response.ok) {
        throw new Error('Failed to load addresses.json');
      }
      addresses = await response.json();
      console.log('Loaded data from static addresses.json file');
    }

    // Validate that addresses is an array
    if (!Array.isArray(addresses)) {
      throw new Error('Address data must be an array of location objects. Current format is invalid.');
    }

    // Validate that we have at least some data
    if (addresses.length === 0) {
      throw new Error('No addresses found');
    }

    // Filter addresses based on requirements:
    // 1. Address must not be empty
    // 2. Latitude and longitude must be present and not zero
    const filteredAddresses = addresses.filter(location => {
      // Filter out rows where address is empty
      if (!location.address || location.address.trim() === '') {
        return false;
      }
      
      // Filter out rows where latitude or longitude is missing or zero
      if (!location.latitude || location.latitude === 0 || 
          !location.longitude || location.longitude === 0) {
        return false;
      }
      
      return true;
    });

    for (const location of filteredAddresses) {
      addPlace(location.address, location.latitude, location.longitude, location.visited);
    }

    fitToMarkers();
    setupFilterButtons();
  }

  function addPlace(address, lat, lng, visited) {
    const index = markers.length;
    const card = document.createElement("div");
    card.className = "place";
    card.dataset.visited = visited; // Store visited status for filtering
    
    // Determine label and color based on visited status
    let visitedLabel, visitedColor;
    if (visited === "Yes") {
      visitedLabel = "✓ Visited";
      visitedColor = "#2e7d32";
    } else if (visited === "No") {
      visitedLabel = "○ Not Visited";
      visitedColor = "#d32f2f";
    } else {
      // For empty/undefined/other values
      visitedLabel = "⊙ Status Unknown";
      visitedColor = "#f57c00";
    }
    
    card.innerHTML = `
      <div class="title">${escapeHtml(address)}</div>
      <div class="meta" style="color:${visitedColor};">${visitedLabel}</div>
    `;

    const centerBtn = document.createElement("button");
    centerBtn.className = "btn btn-center";
    centerBtn.textContent = "Center";
    centerBtn.onclick = () => {
    map.panTo({ lat, lng });
    map.setZoom(16);
    markers[index].info.open(map, markers[index]);
    };

    const mapsBtn = document.createElement("button");
    mapsBtn.className = "btn btn-open";
    mapsBtn.textContent = "Open in Google Maps";
    mapsBtn.onclick = () => {
      const url = `https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(address)}`;
      window.open(url, "_blank");
    };

    // Upload Photo button - navigates to photo upload site with address as URL parameter
    // This URL parameter is used to prefill the address field in the submit-photo flow
    const uploadBtn = document.createElement("button");
    uploadBtn.className = "btn btn-upload";
    uploadBtn.textContent = "Upload Photo";
    uploadBtn.onclick = () => {
      const dest = 'https://swd-carmen.netlify.app/upload.html';
      const u = new URL(dest);
      u.searchParams.set('address', address);
      window.open(u.toString(), "_blank");
    };

    card.appendChild(centerBtn);
    card.appendChild(mapsBtn);
    card.appendChild(uploadBtn);
    placesEl.appendChild(card);

    // Set marker color based on visited status
    let markerColor, infoLabel, infoColor;
    if (visited === "Yes") {
      markerColor = "green";
      infoLabel = "✓ Visited";
      infoColor = "#2e7d32";
    } else if (visited === "No") {
      markerColor = "red";
      infoLabel = "○ Not Visited";
      infoColor = "#d32f2f";
    } else {
      markerColor = "yellow";
      infoLabel = "⊙ Status Unknown";
      infoColor = "#f57c00";
    }
    const iconUrl = `http://maps.google.com/mapfiles/ms/icons/${markerColor}-dot.png`;

    const marker = new google.maps.Marker({
      position: { lat, lng },
      map,
      title: address,
      icon: {
        url: iconUrl,
        scaledSize: new google.maps.Size(32, 32)
      }
    });
    const info = new google.maps.InfoWindow({
      content: `<strong>${escapeHtml(address)}</strong><br><span style="color:${infoColor};">${infoLabel}</span>`
    });
    marker.addListener("click", () => info.open(map, marker));
    marker.info = info;
    marker.visited = visited; // Store visited status for filtering
    markers.push(marker);
  }

  function fitToMarkers() {
    if (!markers.length) return;
    if (markers.length === 1) {
      map.setCenter(markers[0].getPosition());
      map.setZoom(16);
      return;
    }
    const bounds = new google.maps.LatLngBounds();
    markers.forEach(marker => bounds.extend(marker.getPosition()));
    map.fitBounds(bounds, 50);
  }

  function escapeHtml(value) {
    return (value || "").replace(/[&<>"']/g, match => ({
      "&": "&amp;",
      "<": "&lt;",
      ">": "&gt;",
      "\"": "&quot;",
      "'": "&#39;"
    })[match]);
  }

  function setupFilterButtons() {
    const filterButtons = document.querySelectorAll('.filter-btn');
    filterButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        // Update active button
        filterButtons.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        
        // Apply filter
        const filter = btn.dataset.filter;
        currentFilter = filter;
        applyFilter(filter);
      });
    });
  }

  function applyFilter(filter) {
    const places = document.querySelectorAll('.place');
    
    places.forEach((place, index) => {
      const visited = place.dataset.visited;
      let shouldShow = true;
      
      if (filter === 'visited') {
        shouldShow = visited === 'Yes';
      } else if (filter === 'not-visited') {
        shouldShow = visited === 'No';
      } else {
        // filter === 'all', show everything including unknown status
        shouldShow = true;
      }
      
      // Show/hide place card
      place.style.display = shouldShow ? 'block' : 'none';
      
      // Show/hide corresponding marker
      if (markers[index]) {
        markers[index].setVisible(shouldShow);
      }
    });
  }

  // Setup Update Map button
  document.addEventListener('DOMContentLoaded', () => {
    const updateMapBtn = document.getElementById('updateMapBtn');
    if (updateMapBtn) {
      updateMapBtn.addEventListener('click', () => {
        // Simply reload the page
        window.location.reload(true);
      });
    }
    
    // Setup Toggle Map button
    const toggleMapBtn = document.getElementById('toggleMapBtn');
    const mapEl = document.getElementById('map');
    let isMapVisible = true;
    
    if (toggleMapBtn && mapEl) {
      toggleMapBtn.addEventListener('click', () => {
        isMapVisible = !isMapVisible;
        
        if (isMapVisible) {
          // Show map
          mapEl.classList.remove('hidden');
          document.body.classList.remove('map-hidden');
          toggleMapBtn.textContent = 'Hide Map';
        } else {
          // Hide map
          mapEl.classList.add('hidden');
          document.body.classList.add('map-hidden');
          toggleMapBtn.textContent = 'Show Map';
        }
      });
    }
  });
  </script>
</body>
</html>
