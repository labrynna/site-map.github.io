<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Site Visit Map</title>
  <style>
    body { font-family: Arial, Helvetica, sans-serif; margin:0; display:flex; height:100vh; }
    #map { flex:1; min-width: 0; } /* map takes remaining space */
    #sidebar { width:360px; max-width:40%; overflow:auto; border-left:1px solid #ddd; padding:12px; box-sizing:border-box; background:#fafafa; }
    h1 { font-size:18px; margin:0 0 12px 0; }
    .place { padding:8px; margin-bottom:8px; border-radius:6px; background:#fff; box-shadow:0 1px 2px rgba(0,0,0,0.04); }
    .place .title { font-weight:600; font-size:14px; margin-bottom:4px; }
    .place .meta { font-size:12px; color:#666; margin-bottom:8px; }
    .btn { display:inline-block; padding:6px 8px; margin-right:6px; border-radius:4px; text-decoration:none; font-size:13px; cursor:pointer; }
    .btn-center { background:#1976d2; color:white; }
    .btn-open { background:#26a69a; color:white; }
    .note { font-size:12px; color:#555; margin-bottom:10px; }
    footer { font-size:12px; color:#666; margin-top:8px; }
    .filter-section { margin-bottom:16px; padding:10px; background:#fff; border-radius:6px; box-shadow:0 1px 2px rgba(0,0,0,0.04); }
    .filter-section label { display:block; margin-bottom:6px; font-size:13px; font-weight:600; }
    .filter-options { display:flex; gap:8px; }
    .filter-btn { flex:1; padding:8px; border:1px solid #ccc; border-radius:4px; background:#fff; font-size:12px; cursor:pointer; transition: all 0.2s; }
    .filter-btn:hover { background:#f5f5f5; }
    .filter-btn.active { background:#1976d2; color:white; border-color:#1976d2; }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="sidebar">
    <h1>Sites to Visit</h1>
    <div class="note">Addresses below are to be visited for Constructor Information Collection.</div>
    <div class="filter-section">
      <label>Filter:</label>
      <div class="filter-options">
        <button class="filter-btn active" data-filter="all">All</button>
        <button class="filter-btn" data-filter="not-visited">Not Visited</button>
        <button class="filter-btn" data-filter="visited">Visited</button>
      </div>
    </div>
    <div id="places"></div>
    <footer>
      <div>Tip: On mobile, "Open in Google Maps" will switch to the Maps app if installed.</div>
    </footer>
  </div>

  <script>
  const API_KEY = "AIzaSyCxwoR9NMTjxa2Oq7InCcefIBHhrIWHP88";

  let map;
  const markers = [];
  const placesEl = document.getElementById("places");
  let currentFilter = "all";

  function handleError(err) {
    console.error(err);
    placesEl.innerHTML = `<div class="note" style="color:#b00020">Error: ${escapeHtml(err.message || String(err))}</div>`;
  }

  (function loadGoogleMaps() {
    const script = document.createElement("script");
    script.defer = script.async = true;
    script.src = `https://maps.googleapis.com/maps/api/js?key=${encodeURIComponent(API_KEY)}`;
    script.onload = () => init().catch(handleError);
    script.onerror = () => handleError(new Error("Failed to load Google Maps JavaScript API."));
    document.head.appendChild(script);
  })();

  async function init() {
    map = new google.maps.Map(document.getElementById("map"), {
      center: { lat: -33.8688, lng: 151.2093 },
      zoom: 12,
      mapTypeId: "roadmap"
    });

    // Load addresses from JSON file
    const response = await fetch('addresses.json');
    if (!response.ok) {
      throw new Error('Failed to load addresses.json');
    }
    const addresses = await response.json();

    for (const location of addresses) {
      addPlace(location.address, location.latitude, location.longitude, location.visited);
    }

    fitToMarkers();
    setupFilterButtons();
  }

  function addPlace(address, lat, lng, visited) {
    const index = markers.length;
    const card = document.createElement("div");
    card.className = "place";
    card.dataset.visited = visited; // Store visited status for filtering
    const visitedLabel = visited === "Yes" ? "✓ Visited" : "○ Not Visited";
    const visitedColor = visited === "Yes" ? "#2e7d32" : "#d32f2f";
    card.innerHTML = `
      <div class="title">${escapeHtml(address)}</div>
      <div class="meta" style="color:${visitedColor};">${visitedLabel}</div>
    `;

    const centerBtn = document.createElement("button");
    centerBtn.className = "btn btn-center";
    centerBtn.textContent = "Center";
    centerBtn.onclick = () => {
    map.panTo({ lat, lng });
    map.setZoom(16);
    markers[index].info.open(map, markers[index]);
    };

    const mapsBtn = document.createElement("button");
    mapsBtn.className = "btn btn-open";
    mapsBtn.textContent = "Open in Google Maps";
    mapsBtn.onclick = () => {
      const url = `https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(`${lat},${lng}`)}`;
      window.open(url, "_blank");
    };

    card.appendChild(centerBtn);
    card.appendChild(mapsBtn);
    placesEl.appendChild(card);

    // Set marker color based on visited status
    const markerColor = visited === "Yes" ? "green" : "red";
    const iconUrl = `http://maps.google.com/mapfiles/ms/icons/${markerColor}-dot.png`;

    const marker = new google.maps.Marker({
      position: { lat, lng },
      map,
      title: address,
      icon: {
        url: iconUrl,
        scaledSize: new google.maps.Size(32, 32)
      }
    });
    const info = new google.maps.InfoWindow({
      content: `<strong>${escapeHtml(address)}</strong><br><span style="color:${visited === "Yes" ? "#2e7d32" : "#d32f2f"};">${visited === "Yes" ? "✓ Visited" : "○ Not Visited"}</span>`
    });
    marker.addListener("click", () => info.open(map, marker));
    marker.info = info;
    marker.visited = visited; // Store visited status for filtering
    markers.push(marker);
  }

  function fitToMarkers() {
    if (!markers.length) return;
    if (markers.length === 1) {
      map.setCenter(markers[0].getPosition());
      map.setZoom(16);
      return;
    }
    const bounds = new google.maps.LatLngBounds();
    markers.forEach(marker => bounds.extend(marker.getPosition()));
    map.fitBounds(bounds, 50);
  }

  function escapeHtml(value) {
    return (value || "").replace(/[&<>"']/g, match => ({
      "&": "&amp;",
      "<": "&lt;",
      ">": "&gt;",
      "\"": "&quot;",
      "'": "&#39;"
    })[match]);
  }

  function setupFilterButtons() {
    const filterButtons = document.querySelectorAll('.filter-btn');
    filterButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        // Update active button
        filterButtons.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        
        // Apply filter
        const filter = btn.dataset.filter;
        currentFilter = filter;
        applyFilter(filter);
      });
    });
  }

  function applyFilter(filter) {
    const places = document.querySelectorAll('.place');
    
    places.forEach((place, index) => {
      const visited = place.dataset.visited;
      let shouldShow = true;
      
      if (filter === 'visited') {
        shouldShow = visited === 'Yes';
      } else if (filter === 'not-visited') {
        shouldShow = visited === 'No';
      }
      
      // Show/hide place card
      place.style.display = shouldShow ? 'block' : 'none';
      
      // Show/hide corresponding marker
      if (markers[index]) {
        markers[index].setVisible(shouldShow);
      }
    });
  }
  </script>
</body>
</html>
